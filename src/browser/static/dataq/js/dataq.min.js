!function(){window.DataQ=window.DataQ||{},query=null,policy=null;var n;DataQ.DQ=function(o,t){n=t;var e=$(DataQ.templates["dataq-container"]());$("body").append(e),query=DataQ.Query(),query.repo(o),$(".dq-black-background").click(function(){$(".dq-black-background").remove(),$(".dataq").remove(),n(null)})},DataQ.DQ_rls_policy=function(o,t){n=t;var e=$(DataQ.templates["dataq-container-rls-policy"]());$("body").append(e),policy=DataQ.Policy(),policy.repo(o),$(".dq-black-background").click(function(){$(".dq-black-background").remove(),$(".dataq").remove(),n(null)})};var o=function(){$(".dq-selected-tables").html(""),query.get_selected_tables().forEach(function(n){var o=query.selected_columns(n);if(null!==o){var t=[];o.forEach(function(n){"none"===n.agg?t.push(n.name):t.push(n.agg+"("+n.name+")")});var e=DataQ.templates["dq-selected-table"]({table_name:n,column_list:t.join(", ")});$(".dq-selected-tables").append(e)}}),$(".dq-filter-list").html(""),query.get_filters().forEach(function(n){$(".dq-filter-list").append(DataQ.templates["dq-filter-list-item"]({filter:n}))});var n=[];query.grouping().forEach(function(o){n.push(o.string)}),n.length>0?$(".dq-grouping-text").html(n.join(", ")):$(".dq-grouping-text").html("No Grouping...");var o=[];query.sorts().forEach(function(n){o.push(n.string)}),o.length>0?$(".dq-sorting-text").html(o.join(", ")):$(".dq-sorting-text").html("No Sorting...")};$(document).on("click",".dq-btn-add-table",function(){DataQ.TableModal(query,null,o)}),$(document).on("click",".dq-btn-delete-table",function(){var n=$(this).data("tablename");query.operated_column()&&query.operated_column().split(".")[0]===n&&query.operated_column(null),query.selected_columns(n,null),query.update_grouping(),o()}),$(document).on("click",".dq-btn-edit-table",function(){DataQ.TableModal(query,$(this).data("tablename"),o)}),$(document).on("click",".dq-btn-add-filter",function(){DataQ.FilterModal(query,o)}),$(document).on("click",".dq-btn-delete-filter",function(){var n=$(this).parent().data("code");query.delete_filter(n),o()}),$(document).on("click",".dq-btn-edit-grouping",function(){DataQ.GroupingModal(query,o)}),$(document).on("click",".dq-btn-edit-sorting",function(){DataQ.SortModal(query,o)}),$(document).on("click",".dq-btn-cancel-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),n(null)}),$(document).on("click",".dq-btn-run-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),n(DataQ.build_query(query))}),$(document).on("click",".dq-btn-run-policy",function(){$(".dq-black-background").remove(),$(".dataq").remove(),n(DataQ.build_policy(policy))})}(),function(){window.DataQ=window.DataQ||{},DataQ.API={},DataQ.API.get_repos=function(n){$.get("/apps/dataq/api/",n)},DataQ.API.get_tables=function(n,o){$.get("/apps/dataq/api/"+n+"/",o)},DataQ.API.get_schema=function(n,o,t){$.get("/apps/dataq/api/"+n+"/"+o+"/",t)}}(),function(){window.DataQ=window.DataQ||{};var n,o;DataQ.FilterModal=function(t,e){n=e,o=t;var a=$("#dq-filter-modal");if(0===a.length){var r=[];o.get_selected_tables().forEach(function(n){o.schema(n).forEach(function(o){r.push({column_name:o[0],table_name:n,full_name:n+"."+o[0]})})});var l=DataQ.templates["dq-filter-modal"]({columns:r,repo:o.repo()});$("body").append(l)}$("#dq-filter-modal").modal({keyboard:!1}),$(".modal-backdrop").click(function(){n(),$("#dq-filter-modal").remove()})},$(document).on("click",".dq-filter-quit",function(){n(),$("#dq-filter-modal").remove(),$(".modal-backdrop").remove()}),$(document).on("click",".dq-filter-done",function(){var t=$(".dq-filter-1-text").val(),e=$(".dq-filter-2-text").val(),a=$(".dq-filter-op-text").val();t.length>0&&e.length>0&&a.length>0?(o.add_filter(t,a,e),n(),$("#dq-filter-modal").modal("hide"),$("#dq-filter-modal").remove(),$(".modal-backdrop").remove()):alert("You need to fill out the three text boxes")}),$(document).on("click",".dq-filter-1-link",function(){$(".dq-filter-1-text").val($(this).html())}),$(document).on("click",".dq-filter-2-link",function(){$(".dq-filter-2-text").val($(this).html())}),$(document).on("click",".dq-filter-op-link",function(){var n=$(this).html().replace("&gt;",">").replace("&lt;","<");$(".dq-filter-op-text").val(n)})}(),function(){window.DataQ=window.DataQ||{};var n,o;DataQ.GroupingModal=function(t,e){o=t,n=e;var a=$("#dq-grouping-modal");if(0===a.length){var r=DataQ.templates["dq-grouping-modal"]({columns:o.grouping()});$("body").append(r)}$("#dq-grouping-modal").modal({keyboard:!1}),$("#dq-grouping-modal").on("shown.bs.modal",function(){$(".dq-grouping-modal-list").sortable({forcePlaceholderSize:!0})}),$(".modal-backdrop").click(function(){n(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()})},$(document).on("click","#dq-grouping-modal-quit-btn",function(){n(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()}),$(document).on("click","#dq-grouping-modal-done-btn",function(){var t=[];$(".dq-grouping-list-item").each(function(){var n,e=$(this),a=e.data("string");o.grouping();o.grouping().forEach(function(o){o.string===a&&(n=o)}),t.push(n)}),o.grouping(t),n(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()})}(),function(){window.DataQ=window.DataQ||{};for(var n=["bigint","int8","bigserial","serial8","double precision","float8","integer","int","int4","real","float4","smallint","int2","serial","serial4"],o={},t=0;t<n;t++)o[n[t]]=!0;var e={none:"max",max:"min",min:"sum",sum:"count",count:"avg",avg:"none"},a={none:"count",count:"none"};DataQ.next_aggregate=function(n,t){return null===t&&(t="none"),o[n]?e[t]:a[t]}}(),function(){window.DataQ=window.DataQ||{},window.DataQ.build_query=function(n){var o=[],t=[],e=[],a=[],r=[],l=n.repo();if(n.get_selected_tables().forEach(function(n){t.push(l+"."+n)}),n.get_selected_tables().forEach(function(t){n.selected_columns(t).forEach(function(n){void 0===n.agg||null===n.agg||"none"===n.agg?o.push(l+"."+t+"."+n.name):o.push(n.agg+"("+l+"."+t+"."+n.name+") as "+n.agg+"_"+t+"_"+n.name)})}),n.get_filters().forEach(function(n){e.push(n.filter1+" "+n.op+" "+n.filter2)}),n.grouping().forEach(function(n){var o=n.column.agg;null!==o&&void 0!==o&&"none"!==o||a.push(l+"."+n.string)}),n.sorts().forEach(function(n){var o=n.column.agg;null===o||void 0===o||"none"===o?r.push(l+"."+n.string):r.push(o+"_"+n.table+"_"+n.column.name)}),0===o.length)return"";var d="SELECT "+o.join(", ")+" FROM "+t.join(", ");return e.length>0&&(d+=" WHERE "+e.join(" AND ")),a.length>0&&(d+=" GROUP BY "+a.join(", ")),r.length>0&&(d+=" ORDER BY "+r.join(", ")),d.trim(),d+=";"}}(),function(){window.DataQ=window.DataQ||{},DataQ.Query=function(){var n={};return n._schema_for_table_name={},n._repo_name=null,n._operated_column=null,n._selected_columns_for_table={},n._filter_for_code={},n._grouping=[],n._sorts={},n.schema=function(o,t){return void 0!==t&&(n._schema_for_table_name[o]=t),n._schema_for_table_name[o]},n.repo=function(o){return void 0!==o&&(n._repo_name=o),n._repo_name},n.operated_column=function(o){return void 0!==o&&(n._operated_column=o),n._operated_column},n.update_grouping=function(){n._grouping=[];var o=!1;for(var t in n._selected_columns_for_table)n._selected_columns_for_table[t]&&n._selected_columns_for_table[t].forEach(function(e){"none"===e.agg?n._grouping.push({string:t+"."+e.name,table:t,column:e}):o=!0});o||(n._grouping=[])},n.selected_columns=function(o,t){return void 0!==t&&(n._selected_columns_for_table[o]=t),n._selected_columns_for_table[o]},n.get_selected_tables=function(){var o=[];for(var t in n._selected_columns_for_table)o.push(t);return o},n.add_filter=function(o,t,e){var a=o+" "+t+" "+e,r=md5((new Date).getTime()+a);return n._filter_for_code[r]={filter1:o,op:t,filter2:e,filter_string:a},n._filter_for_code[r]},n.delete_filter=function(o){n._filter_for_code[o]=void 0},n.get_filters=function(){var o=[];for(var t in n._filter_for_code){var e=n._filter_for_code[t];e&&o.push({code:t,filter1:e.filter1,op:e.op,filter2:e.filter2,filter_string:e.filter_string})}return o},n.grouping=function(o){return void 0!==o&&(n._grouping=o),n._grouping},n.add_sort=function(o){n._sorts[o.string]=o},n.delete_sort=function(o){n._sorts[o]=void 0},n.sorts=function(){var o=[];for(var t in n._sorts)void 0!==n._sorts[t]&&o.push(n._sorts[t]);return o},n}}(),function(){window.DataQ=window.DataQ||{},window.DataQ.build_policy=function(n){var o=n.name(),t=n.repo()+"."+n.name(),e=n.command(),a=n.roles(),r=n.using_expression(),l=n.check_expression(),d="CREATE POLICY "+o;return d+=" ON "+t,d+=" FOR "+e,d+=" TO "+a.join(", "),d+=" USING "+r,"SELECT"!==e&&(d+=" WITH CHECK "+l),d.trim(),d+=";"}}(),function(){window.DataQ=window.DataQ||{},DataQ.Policy=function(){var n={};return n._repo_name=null,n._name=null,n._table=null,n._command=null,n._roles=[],n._using_expr=null,n._check_expr=null,n.repo=function(o){return void 0!==o&&(n._repo_name=o),n._repo_name},n.name=function(o){return void 0!==o&&(n._name=o),n._name},n.table=function(o){return void 0!==o&&(n._table=o),n._table},n.command=function(o){return void 0!==o&&(n._command=o),n._command},n.roles=function(o){return void 0!==o&&(o instanceof Array||(o=[o]),n._roles=o),n._roles},n.using_expression=function(o){return void 0!==o&&(n._using_expr=o),n._using_expr},n.check_expression=function(o){return void 0!==o&&(n._check_expr=o),n._check_expr},n}}(),function(){window.DataQ=window.DataQ||{};var n,o;DataQ.SortModal=function(t,a){o=t,n=a;var r=$("#dq-sort-modal");if(0===r.length){var l=DataQ.templates["dq-sort-modal"]();$("body").append(l)}$("#dq-sort-modal").modal({keyboard:!1}),$("#dq-sort-modal").on("shown.bs.modal",function(){e()}),$(".modal-backdrop").click(function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),n()})},$(document).on("click",".dq-sort-modal-dropdown-btn",function(){var n=$(".dq-sort-modal-dropdown");n.html(""),t().forEach(function(o){n.append(DataQ.templates["dq-sort-dropdown-li"]({item:o}))})});var t=function(){var n={};o.sorts().forEach(function(o){n[o.string]=!0});var t=[];return o.get_selected_tables().forEach(function(e){o.selected_columns(e).forEach(function(o){var a=e+"."+o.name;"none"!==o.agg&&(a=o.agg+"("+e+"."+o.name+")"),n[a]||t.push({string:a,table:e,column:o})})}),t},e=function(){var n=$(".dq-sort-item-list");n.html(""),o.sorts().forEach(function(o){var t=DataQ.templates["dq-sort-list-item"]({item:o});n.append(t)})};$(document).on("click",".dq-sort-modal-quit",function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),n()}),$(document).on("click",".dq-sort-link",function(){var n=$(this),t=n.data("columnname"),a=n.data("columntype"),r=n.data("aggregate"),l=n.data("table"),d=n.data("string");void 0!==r&&null!==r||(r="none");var i={column:{name:t,type:a,agg:r},string:d,table:l};o.add_sort(i),e()}),$(document).on("click",".dq-sort-modal-done-btn",function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),n()}),$(document).on("click",".dq-sort-delete-btn",function(){var n=$(this).parent().parent(),t=n.data("string");o.delete_sort(t),e()})}(),function(){window.DataQ=window.DataQ||{};var n,o,t;DataQ.TableModal=function(a,r,l){o=r,n=l,t=a;var d=$("#dq-table-modal");if(0===d.length){var i=DataQ.templates["dq-table-modal"]({table_name:o});$("body").append(i)}$("#dq-table-modal").modal({keyboard:!1}),$(".dq-modal-done-btn").hide(),$("#dq-table-modal").on("shown.bs.modal",function(){o&&e(o)}),$(".modal-backdrop").click(function(){$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),n()})},$(document).on("click",".dq-modal-quit",function(){$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),n()}),$(document).on("click",".dq-modal-dropdown-btn",function(){var n=$(".dq-modal-dropdown");n.html(""),DataQ.API.get_tables(t.repo(),function(o){o.tables.forEach(function(o){var t=DataQ.templates["dq-modal-dropdown-item"]({item_name:o});n.append(t)})})}),$(document).on("click",".dq-modal-dropdown-link",function(){var n=$(this).data("item_name");o=n,$(".dq-modal-table-dropdown-text").text(o),e()});var e=function(){DataQ.API.get_schema(t.repo(),o,function(n){$(".dq-modal-done-btn").show(),t.schema(o,n.schema).sort(function(n,o){return n[0]>o[0]});var e=DataQ.templates["dq-modal-columns"]({columns:t.schema(o)});$(".dq-column-list").html(e),t.selected_columns(o)&&t.selected_columns(o).forEach(function(n){var o=$('.dq-modal-column[data-columnname="'+n.name+'"]');o.data("columnname",n.name),o.data("columntype",n.type),o.data("currentaggregate",n.agg||"none"),o.find("input[type=checkbox]").prop("checked",!0),"none"!==n.agg&&o.find("button").text(n.agg+"("+n.name+")")})})};$(document).on("click",".dq-modal-column button",function(){var n=$(this).parent(),e=n.data("columnname"),a=n.data("columntype"),r=n.data("currentaggregate"),l=DataQ.next_aggregate(a,r);t.operated_column()!==o+"."+e&&null!==t.operated_column()&&(l="none"),"none"===l?(t.operated_column()===o+"."+e&&t.operated_column(null),$(this).text(e)):($(this).text(l+"("+e+")"),t.operated_column(o+"."+e)),n.data("currentaggregate",l)}),$(document).on("click",".dq-modal-done-btn",function(){var e=[],a=!1;$(".dq-modal-column").each(function(){var n=$(this);if(n.find("input").is(":checked")){var r=n.data("currentaggregate"),l=n.data("columntype"),d=n.data("columnname");o+"."+d===t.operated_column()&&(a=!0),null!==r&&void 0!==r||(r="none"),e.push({name:d,type:l,agg:r})}}),t.operated_column()&&t.operated_column().split(".")[0]===o&&!a&&t.operated_column(null),t.selected_columns(o,e),t.update_grouping(),$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),n()})}();
//# sourceMappingURL=dataq.min.js.map
